<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="CcDispatch_Mapper" >
  <resultMap id="BaseResultMap" type="com.e9cloud.mybatis.domain.CcDispatch" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    <id column="id" property="id" jdbcType="INTEGER" />
    <result column="dispatch_id" property="dispatchId" jdbcType="VARCHAR" />
    <result column="dispatch_name" property="dispatchName" jdbcType="VARCHAR" />
    <result column="sid" property="sid" jdbcType="VARCHAR" />
    <result column="area_id" property="areaId" jdbcType="VARCHAR" />
    <result column="time_start" property="timeStart" jdbcType="INTEGER" />
    <result column="time_end" property="timeEnd" jdbcType="INTEGER" />
    <result column="weekday" property="weekday" jdbcType="INTEGER" />
    <result column="valid_date" property="validDate" jdbcType="TIMESTAMP" />
    <result column="remark" property="remark" jdbcType="VARCHAR" />
    <result column="ctime" property="ctime" jdbcType="TIMESTAMP" />
  </resultMap>

  <sql id="Base_Column_List" >
    id, dispatch_id, dispatch_name, sid, area_id, time_start, time_end,weekday, valid_date,
    remark, ctime
  </sql>

  <!-- 分页选取话务调度列表 -->
  <select id="pageCcDispatchList" resultType="map" parameterType="Page">
    <include refid="com.e9cloud.pre"/>
    select tc.id,tc.dispatch_name,tc.dispatch_id,tc.sid,tc.area_id,tc.time_start,tc.time_end,
    tc.weekday,tc.valid_date,tc.remark,tc.ctime,tc.status,
    tuc.name,ta.app_name,ta.appid,tc.dispatch_name dispatchName,tca.aname,m.ccname
    from tb_cc_dispatch tc
    left join tb_user_admin tu on tc.sid=tu.sid
    left join tb_user_admin_authen_company tuc on tu.uid=tuc.uid
    left join tb_cc_area tca on tc.area_id=tca.area_id
    left join (
    select max(t.sid) sid,max(t.appid) appid,max(t.app_name) app_name
    from tb_app_info t
    <if test="params.abustype != null and params.abustype != ''">
      WHERE t.bus_type = #{params.abustype,jdbcType=VARCHAR}
    </if>
    group by t.sid
    )ta on tc.sid=ta.sid
    LEFT JOIN (
    SELECT a.dispatch_id,group_concat(concat(c.ccname,'-',b.pri) ORDER BY b.pri separator ',') AS ccname
    from tb_cc_dispatch a LEFT JOIN tb_cc_dispatch_info b ON a.dispatch_id = b.dispatch_id
    LEFT JOIN tb_cc_info c ON b.subid = c.subid
    GROUP BY dispatch_id
    )m ON tc.dispatch_id = m.dispatch_id
    where 1=1 AND tc.status = '00'
    <if test="params.sid != null and params.sid != ''">
      and tc.sid = #{params.sid,jdbcType=VARCHAR}
    </if>
    <if test="params.name != null and params.name != ''">
      and tuc.name LIKE "%"#{params.name,jdbcType=VARCHAR}"%"
    </if>
    <if test="params.appName != null and params.appName != ''">
      and ta.app_name LIKE "%"#{params.appName,jdbcType=VARCHAR}"%"
    </if>
    <if test="params.dispatchName != null and params.dispatchName != ''">
      and tc.dispatch_name LIKE "%"#{params.dispatchName,jdbcType=VARCHAR}"%"
    </if>
    <if test="params.appid != null and params.appid != ''">
      and ta.appid = #{params.appid,jdbcType=INTEGER}
    </if>
    <if test="params.areaId != null and params.areaId != '' and params.areaId != 'all'">
      and tc.area_id = #{params.areaId,jdbcType=INTEGER}
    </if>
    <if test="timemin != null">
      and tc.ctime &gt;= #{timemin,jdbcType=TIMESTAMP}
    </if>
    <if test="timemax != null">
      and tc.ctime &lt;= #{timemax,jdbcType=TIMESTAMP}
    </if>

    <if test="sidx != null and sidx != ''">
      order by ${sidx} ${sord}
    </if>
    <include refid="com.e9cloud.suf"/>
  </select>

  <insert id="saveCcDispatch" parameterType="com.e9cloud.mybatis.domain.CcDispatch" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    insert into tb_cc_dispatch
    <trim prefix="(" suffix=")" suffixOverrides="," >
      <if test="id != null" >
        id,
      </if>
      <if test="dispatchName != null" >
        dispatch_name,
      </if>
      <if test="dispatchId != null" >
        dispatch_id,
      </if>
      <if test="sid != null" >
        sid,
      </if>
      <if test="areaId != null" >
        area_id,
      </if>
      <if test="timeStart != null" >
        time_start,
      </if>
      <if test="timeEnd != null" >
        time_end,
      </if>
      <if test="weekday != null" >
        weekday,
      </if>
      <if test="validDate != null" >
        valid_date,
      </if>
      <if test="remark != null" >
        remark,
      </if>
      <if test="ctime != null" >
        ctime,
      </if>
      <if test="status != null" >
        status,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides="," >
      <if test="id != null" >
        #{id,jdbcType=INTEGER},
      </if>
      <if test="dispatchName != null" >
        #{dispatchName,jdbcType=VARCHAR},
      </if>
      <if test="dispatchId != null" >
        #{dispatchId,jdbcType=VARCHAR},
      </if>
      <if test="sid != null" >
        #{sid,jdbcType=VARCHAR},
      </if>
      <if test="areaId != null" >
        #{areaId,jdbcType=VARCHAR},
      </if>
      <if test="timeStart != null" >
        #{timeStart,jdbcType=INTEGER},
      </if>
      <if test="timeEnd != null" >
        #{timeEnd,jdbcType=INTEGER},
      </if>
      <if test="weekday != null" >
        #{weekday,jdbcType=INTEGER},
      </if>
      <if test="validDate != null" >
        #{validDate,jdbcType=TIMESTAMP},
      </if>
      <if test="remark != null" >
        #{remark,jdbcType=VARCHAR},
      </if>
      <if test="ctime != null" >
        #{ctime,jdbcType=TIMESTAMP},
      </if>
      <if test="status != null" >
        #{status,jdbcType=VARCHAR},
      </if>
    </trim>
  </insert>

  <update id="updateCcDispatch" parameterType="com.e9cloud.mybatis.domain.CcDispatch" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    update tb_cc_dispatch
    <set >
      <if test="dispatchName != null" >
        dispatch_name = #{dispatchName,jdbcType=VARCHAR},
      </if>
      <if test="dispatchId != null" >
        dispatch_id = #{dispatchId,jdbcType=VARCHAR},
      </if>
      <if test="sid != null" >
        sid = #{sid,jdbcType=VARCHAR},
      </if>
      <if test="areaId != null" >
        area_id = #{areaId,jdbcType=VARCHAR},
      </if>
      <if test="timeStart != null" >
        time_start = #{timeStart,jdbcType=INTEGER},
      </if>
      <if test="timeEnd != null" >
        time_end = #{timeEnd,jdbcType=INTEGER},
      </if>
      <if test="weekday != null" >
        weekday = #{weekday,jdbcType=INTEGER},
      </if>
      <if test="validDate != null" >
        valid_date = #{validDate,jdbcType=TIMESTAMP},
      </if>
      <if test="remark != null" >
        remark = #{remark,jdbcType=VARCHAR},
      </if>
      <if test="status != null" >
        status = #{status,jdbcType=VARCHAR},
      </if>
    </set>
    where id = #{id,jdbcType=INTEGER}
  </update>

  <resultMap id="nameResultMap" type="com.e9cloud.mybatis.domain.CcDispatch" extends="BaseResultMap">
    <result column="name" property="name" jdbcType="VARCHAR" />
    <result column="app_name" property="appName" jdbcType="VARCHAR" />
    <result column="aname" property="aname" jdbcType="VARCHAR" />
  </resultMap>

  <select id="queryCcDispatchById" resultMap="nameResultMap" parameterType="java.lang.String" >
    select
        tc.id,tc.dispatch_name dispatchName,tc.dispatch_id,tc.area_id,tc.time_start,tc.time_end,tc.weekday,tc.valid_date,tc.remark,tc.ctime,tc.sid,
        tuc.name,ta.app_name,ta.appid,tca.aname
    from tb_cc_dispatch tc
    left join tb_user_admin tu on tc.sid=tu.sid
    left join tb_user_admin_authen_company tuc on tu.uid=tuc.uid
    left join tb_cc_area tca on tc.area_id=tca.area_id
    left join (
        select max(t.sid) sid,max(t.appid) appid,max(t.app_name) app_name
        from tb_app_info t
        group by t.sid
    )ta on tc.sid=ta.sid
    where tc.id = #{id,jdbcType=INTEGER}
  </select>

  <select id="findCompanyNameAndSidByPage" resultType="map" parameterType="Page" >
    <include refid="com.e9cloud.pre"/>
    select a.sid,b.name from tb_user_admin as a, tb_user_admin_authen_company as b,tb_business_type as c
    where a.uid = b.uid AND a.sid = c.sid
    <if test="params.name != null and params.name != ''">
      AND b.name LIKE CONCAT('%',#{params.name,jdbcType=VARCHAR},'%')
    </if>
    <if test="params.sid != null and params.sid != ''">
      AND a.sid LIKE CONCAT('%',#{params.sid,jdbcType=VARCHAR},'%')
    </if>
    <if test="params.busType != null and params.busType != ''">
      AND c.bus_type = #{params.busType,jdbcType=VARCHAR}
    </if>
    <include refid="com.e9cloud.suf"/>
  </select>

  <select id="countDispatchBySidAndDispatchName" resultType="long" parameterType="com.e9cloud.mybatis.domain.CcDispatch" >
    select
    count(1)
    from tb_cc_dispatch
    where status = '00' AND id != #{id,jdbcType=INTEGER}
    AND dispatch_name = #{dispatchName,jdbcType=VARCHAR}
    AND sid = #{sid,jdbcType=VARCHAR}
  </select>

  <select id="getDispatchByAreaId" resultMap="BaseResultMap" parameterType="java.lang.String" >
    select
    <include refid="Base_Column_List" />
    from tb_cc_dispatch
    where status='00'
    AND area_id = #{areaId,jdbcType=VARCHAR}
  </select>

  <select id="getDispatchBySubId" resultMap="BaseResultMap" parameterType="java.lang.String" >
    SELECT cd.dispatch_name
    from tb_cc_dispatch_info cdi,tb_cc_dispatch cd
    WHERE status = '00' AND cdi.dispatch_id=cd.dispatch_id
    AND cdi.subid=#{subid,jdbcType=VARCHAR}
  </select>

</mapper>